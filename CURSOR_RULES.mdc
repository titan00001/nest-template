---
alwaysApply: false
---

# ğŸ¯ Cursor Rules: Entity â†” DTO Separation

## Core Principle
**Entity = Internal Model (DB, business logic, private)**
**DTO = External Contract (request in / response out)**

## ğŸš¨ Critical Rules

### 1. **Never Return Entities Directly**
```ts
// âŒ WRONG
return user; // Entity with password, tokens, etc.

// âœ… CORRECT
return UserMapper.toResponseDto(user);
```

### 2. **Always Use Mappers**
```ts
// Create mapper for each entity
export class EntityMapper {
  static toResponseDto(entity: Entity): ResponseDto {
    return plainToInstance(ResponseDto, {
      // Map only safe fields
      id: entity._id,
      name: entity.name,
      // NEVER: password, tokens, internalFlags
    }, { excludeExtraneousValues: true });
  }
}
```

### 3. **Use @Expose() for Whitelisting**
```ts
export class ResponseDto {
  @Expose() id: string;      // âœ… Safe
  @Expose() name: string;    // âœ… Safe
  // password: string;       // âŒ Never expose
}
```

### 4. **Handle Different Actors**
```ts
// Multiple DTOs for different contexts
UserPublicDto    // Basic info
UserAdminDto     // + sensitive fields
UserSelfDto      // + personal data
```

### 5. **Computed Fields in DTOs**
```ts
export class ResponseDto {
  @Expose()
  get fullName(): string {
    return `${this.firstName} ${this.lastName}`;
  }
}
```

## ğŸ“ Folder Structure
```
feature/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request.dto.ts      # Input validation
â”‚   â”œâ”€â”€ response.dto.ts     # Output contract
â”‚   â””â”€â”€ update.dto.ts       # Partial updates
â”œâ”€â”€ mappers/
â”‚   â””â”€â”€ entity.mapper.ts    # Entity â†” DTO transformations
â”œâ”€â”€ entity.schema.ts        # Database model
â””â”€â”€ service.ts             # Business logic
```

## ğŸ”„ Flow Pattern
1. **Controller** receives DTO
2. **Service** works with Entity
3. **Mapper** transforms Entity â†’ ResponseDTO
4. **Controller** returns ResponseDTO

## âš ï¸ Edge Cases to Handle
- Sensitive field leakage
- Different shapes per actor
- Partial updates (PATCH)
- Nested relations
- Computed/virtual fields
- Pagination metadata
- Error response DTOs

## ğŸ¯ Remember
**DTOs are contracts, not just shapes. Keep them stable, versioned, and secure.**
# ğŸ¯ Cursor Rules: Entity â†” DTO Separation

## Core Principle
**Entity = Internal Model (DB, business logic, private)**
**DTO = External Contract (request in / response out)**

## ğŸš¨ Critical Rules

### 1. **Never Return Entities Directly**
```ts
// âŒ WRONG
return user; // Entity with password, tokens, etc.

// âœ… CORRECT
return UserMapper.toResponseDto(user);
```

### 2. **Always Use Mappers**
```ts
// Create mapper for each entity
export class EntityMapper {
  static toResponseDto(entity: Entity): ResponseDto {
    return plainToInstance(ResponseDto, {
      // Map only safe fields
      id: entity._id,
      name: entity.name,
      // NEVER: password, tokens, internalFlags
    }, { excludeExtraneousValues: true });
  }
}
```

### 3. **Use @Expose() for Whitelisting**
```ts
export class ResponseDto {
  @Expose() id: string;      // âœ… Safe
  @Expose() name: string;    // âœ… Safe
  // password: string;       // âŒ Never expose
}
```

### 4. **Handle Different Actors**
```ts
// Multiple DTOs for different contexts
UserPublicDto    // Basic info
UserAdminDto     // + sensitive fields
UserSelfDto      // + personal data
```

### 5. **Computed Fields in DTOs**
```ts
export class ResponseDto {
  @Expose()
  get fullName(): string {
    return `${this.firstName} ${this.lastName}`;
  }
}
```

## ğŸ“ Folder Structure
```
feature/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request.dto.ts      # Input validation
â”‚   â”œâ”€â”€ response.dto.ts     # Output contract
â”‚   â””â”€â”€ update.dto.ts       # Partial updates
â”œâ”€â”€ mappers/
â”‚   â””â”€â”€ entity.mapper.ts    # Entity â†” DTO transformations
â”œâ”€â”€ entity.schema.ts        # Database model
â””â”€â”€ service.ts             # Business logic
```

## ğŸ”„ Flow Pattern
1. **Controller** receives DTO
2. **Service** works with Entity
3. **Mapper** transforms Entity â†’ ResponseDTO
4. **Controller** returns ResponseDTO

## âš ï¸ Edge Cases to Handle
- Sensitive field leakage
- Different shapes per actor
- Partial updates (PATCH)
- Nested relations
- Computed/virtual fields
- Pagination metadata
- Error response DTOs

## ğŸ¯ Remember
**DTOs are contracts, not just shapes. Keep them stable, versioned, and secure.**
